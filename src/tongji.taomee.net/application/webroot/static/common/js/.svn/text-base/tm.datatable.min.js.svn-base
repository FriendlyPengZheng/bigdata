/*! taomee tongji javascript code by maverick 2015-02-04 */
!function(a){"use strict";a.datatable={},a.datatable.sort={"percentage-pre":function(a){return a?"-"==a||""===a?0:1*a.replace("%",""):0},"percentage-asc":function(a,b){return a-b},"percentage-desc":function(a,b){return b-a},"string-pre":function(a){return"string"!=typeof a&&(a=null!==a&&a.toString?a.toString():""),a.toLowerCase()},"string-asc":function(a,b){return b>a?-1:a>b?1:0},"string-desc":function(a,b){return b>a?1:a>b?-1:0},"date-pre":function(a){var b=Date.parse(a);return(isNaN(b)||""===b)&&(b=Date.parse("01/01/1970 00:00:00")),b},"date-asc":function(a,b){return a-b},"date-desc":function(a,b){return b-a},"number-pre":function(a){return"-"==a||""===a?0:1*a},"number-asc":function(a,b){return a-b},"number-desc":function(a,b){return b-a}},a.widget("tm.datatable",{options:{sortType:["asc","desc"],pageSizeEnabled:!1,pageSize:10,pageSizeChangeEnabled:!1,size:[5,10,20,50,100],pageSizeContainer:null,searchContainer:null,searchEnabled:!1},table:null,tableColumns:[],tableData:[],displayMaster:[],display:[],sort:null,sortType:null,sortFixed:[],displayStart:0,displayEnd:0,pageSize:null,pagination:null,_create:function(){var a=this.options;this.sort=[0,"desc",0],this.element.addClass("datatable-wrapper"),this.table=this.element.find("table").first().addClass("datatable"),this.tableColumns=[],this.tableData=[],this.displayMaster=[],this.sortFixed=[],this.sortType=this.options.sortType,this._fetchColumns(),this._fetchData(),this.pageSize=this.displayMaster.length,this.table.addClass("sortable"),this._prepareSort(),a.pageSizeEnabled&&this._initPage(),a.pageSizeChangeEnabled&&this._initSize(),a.searchEnabled&&this._initSearch(),this._initSortEvent()},_initSearch:function(){var b,c,d,e,f=a("<div>").addClass("datatable-search"),g=a("<label>"),h=a("<input/>").addClass("search-ipt"),i=this;h.on("input",function(){d=a(this).val(),i.displayMaster=[],a(i.tableData).each(function(){for(e=0,c=this.data.length;c>e;){if(this.data[e].toString().indexOf(d)>-1){i.displayMaster.push(this.index);break}e++}}),b&&window.clearTimeout(b),b=window.setTimeout(function(){i._sortable()},200)}),g.append("搜索").append(h),this.options.searchContainer?this.options.searchContainer.append(f.append(g)):this.element.prepend(f.append(g))},_initSize:function(){var b=a("<div>").addClass("datatable-size"),c=a("<label>"),d=a("<select>"),e=this;a.each(this.options.size,function(){d.append("<option "+(this==e.pageSize?"selected":"")+">"+this+"</option>")}),d.on("change",function(){e.pageSize=a(this).val(),e._resetPage(),e._calculateEnd(),e._drawRow()}),c.append("每页显示").append(d).append("条数据"),this.options.pageSizeContainer?this.options.pageSizeContainer.append(b.append(c)):this.element.prepend(b.append(c))},_initPage:function(){var b=this;this.pageSize=this.options.pageSize,this.pagination=new a.page.PageFactory({showNum:this.pageSize,container:this.element,total:this.tableData.length,preEvent:function(a,c){b.displayStart=(a-1)*c,b._calculateEnd(),b._drawRow()},nextEvent:function(a,c){b.displayStart=(a-1)*c,b._calculateEnd(),b._drawRow()}})},_resetPage:function(){this.displayStart=0,this.pagination&&this.pagination.resetPageBar()},_calculateEnd:function(){(this.displayEnd=this.displayStart+this.pageSize)>this.display.length&&(this.displayEnd=this.display.length)},_drawRow:function(){var b=this.displayStart,c=this.displayEnd,d=a(this.table.find("tbody").get(0)).empty();if(this.display.length)for(b;c>b;b++)d.append(this.tableData[this.display[b]].tr.clone(!0))},_initSortEvent:function(){var b=this;a.each(this.tableColumns,function(){var c=this;this.disabled||a(this.th).on("click",function(){a(b.tableColumns[b.sort[0]].th).removeClass("sorting-"+b.sort[1]),b.sort[0]!=c.index&&(b.sort=[c.index]),b.sort[2]=b.sortType[b.sort[2]+1]?b.sort[2]+1:0,b.sort[1]=b.sortType[b.sort[2]],b._sortable()})}),this._sortable()},_sortable:function(){var b=this,c=this.sort,d=this.tableData;this.displayMaster.sort(function(e,f){var g=b.tableColumns[c[0]].dataType;return a.datatable.sort[(g?g:"string")+"-"+c[1]](d[e].dataSort[c[0]],d[f].dataSort[c[0]])}),a(this.tableColumns[c[0]].th).addClass("sorting-"+c[1]),this.display=this.sortFixed.concat(this.displayMaster),this._resetPage(),this._calculateEnd(),this._drawRow()},_prepareSort:function(){var b,c,d,e,f=this.tableColumns,g=f.length,h=this.tableData,i=h.length;for(d=0;g>d;d++)for(f[d].disabled?d===this.sort[0]&&this.sort[0]++:a(f[d].th).addClass("sorting").append(a("<i>")),c=f[d].dataType,f[d].sort.push("pre",0),b=a.datatable.sort[(c?c:"string")+"-pre"],e=0;i>e;e++)h[e].dataSort.push(b(h[e].data[d]))},_fetchData:function(){for(var b,c,d=this.table.find("tbody").get(0).firstChild,e=this.tableData.length;d;){if("TR"===d.nodeName.toUpperCase()){for(this.tableData.push({index:e,tr:a(d).clone(!0),sortFixed:-1!==a.inArray(e,this.options.sortFixed),dataSort:[],data:[]}),-1!==a.inArray(e,this.options.sortFixed)?this.sortFixed.push(e):this.displayMaster.push(e),c=d.firstChild;c;)b=c.nodeName.toUpperCase(),("TD"===b||"TH"===b)&&this.tableData[e].data.push(a.trim(c.innerHTML)),c=c.nextSibling;e++}d=d.nextSibling}},_fetchColumns:function(){var a=this.table.get(0).getElementsByTagName("thead");0!==a.length&&this._detectHeader(a)},_detectHeader:function(b){for(var c,d=a(b).children("tr").get(0).firstChild,e=this.tableColumns.length;d;)c=d.nodeName.toUpperCase(),("TD"===c||"TH"===c)&&this._addColumn(d,e++),d=d.nextSibling},_addColumn:function(b,c){this.tableColumns.push({th:b,title:b.innerHTML,index:c,disabled:a(b).attr("data-disabled"),dataType:a(b).attr("data-type"),sort:[c]})},_init:function(){},refresh:function(){this.tableData=[],this.displayMaster=[],this.sortFixed=[],this._fetchData(),this.pageSize=this.displayMaster.length,this._prepareSort(),this._sortable()},show:function(){}})}(jQuery);